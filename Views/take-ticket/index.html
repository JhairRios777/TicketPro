<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tome su ticket</title>
    <link href="/Content/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/Content/dist/css/custom-themes.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body{min-height:100vh;display:flex;flex-direction:column}
        .topbar{height:70px;background:var(--theme-red-primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 1rem}
        .brand{font-weight:700;font-size:2rem}
        .main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:3rem}
        .big-btn{width:60%;padding:1.75rem;border-radius:12px;background:var(--theme-red-primary);color:#fff;font-weight:700;font-size:2.5rem;border:none;margin:1rem 0}
        @media (max-width:768px){.big-btn{width:90%}}
    </style>
</head>
<body class="theme-red">
    <header class="topbar">
        <div class="brand"><img src="../../Content/Demo/img/LOGO_BAC.png" alt="Logo BAC" class="img-logo-selection"></div>
        <div id="clock" style="font-weight:700; font-size:1.25rem">--:--</div>
    </header>
    <main class="main">
        <h1 style="color:var(--theme-red-primary);font-weight:800;font-size:3rem">BIENVENIDO</h1>
        <div id="steps" style="width:100%;max-width:800px;margin-top:2rem">
            <div id="service-list" style="display:flex;flex-direction:column;align-items:center;gap:1rem">
                <button class="big-btn" data-service="caja">Caja</button>
                <button class="big-btn" data-service="atencion">Atenci칩n al Cliente</button>
            </div>

            <div id="message" style="margin-top:1.5rem;display:none"></div>
        </div>
    </main>

    <script>
    function updateClock(){
        const d=new Date();
        const h=d.getHours().toString().padStart(2,'0');
        const m=d.getMinutes().toString().padStart(2,'0');
        document.getElementById('clock').textContent = `${h}:${m} p.m.`;
    }
    updateClock(); setInterval(updateClock,60000);

    // Read client_type from querystring (set by selection page)
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }

    const clientTypeParam = (getQueryParam('client_type') || 'general').toLowerCase();

    // Maps: adjust these IDs to match your DB if different
    const clientTypeMap = {
        'general': 1,
        'preferencial': 2,
        'preferential': 2
    };

    const serviceMap = {
        'caja': 1,
        'atencion': 2,
        'atenci칩n': 2
    };

    // showMessage stays for compatibility but uses SweetAlert toast
    function showMessage(text, isError) {
        if (window.Swal) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: isError ? 'error' : 'success',
                title: text,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
            return;
        }
        const el = document.getElementById('message');
        el.style.display = 'block';
        el.style.color = isError ? '#b02a37' : '#0b6e3a';
        el.textContent = text;
    }

    document.querySelectorAll('#service-list .big-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const serviceKey = btn.getAttribute('data-service');
            const serviceId = serviceMap[serviceKey];
            const clientTypeId = clientTypeMap[clientTypeParam] || clientTypeMap['general'];

            if (!serviceId) {
                showMessage('Servicio no configurado. Contacte al administrador.', true);
                return;
            }

            // Show SweetAlert loading modal
            if (window.Swal) {
                Swal.fire({
                    title: 'Generando su ticket...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            } else {
                showMessage('Generando su ticket...');
            }

            try {
                const form = new FormData();
                form.append('service_id', serviceId);
                form.append('client_type_id', clientTypeId);
                // APIR basic API credentials (required when no session)
                form.append('uid', 'consultasAPI');
                form.append('pw', 'API*Data123*');

                const resp = await fetch('/APIR/index.php?method=create_ticket', { method: 'POST', body: form });
                const data = await resp.json();
                if (!data || !data.success) {
                    const msg = (data && data.message) ? data.message : 'Respuesta inv치lida';
                    if (window.Swal) Swal.fire({icon:'error', title:'Error', text: 'Error al crear ticket: ' + msg});
                    else showMessage('Error al crear ticket: ' + msg, true);
                    return;
                }

                const pdfUrl = data.pdf_url || ('/APIR/index.php?method=ticket_pdf&id=' + encodeURIComponent(data.id));

                // Close loading modal then show short success message and open pdf
                if (window.Swal) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Tome su ticket',
                        text: 'C칩digo: ' + (data.ticket_code || ''),
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        allowOutsideClick: false
                    }).then(() => {
                        // Open PDF and redirect back to selection
                        window.open(pdfUrl, '_blank');
                        setTimeout(() => { window.location.href = '/Views/selection/index.html'; }, 300);
                    });
                } else {
                    showMessage('Ticket creado: ' + data.ticket_code + '. Abriendo recibo...');
                    window.open(pdfUrl, '_blank');
                    setTimeout(() => { window.location.href = '/Views/selection/index.html'; }, 1200);
                }

            } catch (err) {
                console.error(err);
                if (window.Swal) Swal.fire({icon:'error', title:'Error', text: 'Error al crear ticket: ' + err.message});
                else showMessage('Error al crear ticket: ' + err.message, true);
            }
        });
    });
    </script>
</body>
</html>